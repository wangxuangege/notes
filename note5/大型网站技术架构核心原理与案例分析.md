大型网站技术架构核心原理与案例分析
=================

# 1. 大型网站架构演化

![架构演化图](static/大型网站架构演化.jpg)

# 2. 网站架构模式

- 1 分层

- 2 拆分

- 3 分布式

&nbsp;&nbsp;&nbsp;&nbsp;1)分布式应用和服务；

&nbsp;&nbsp;&nbsp;&nbsp;2）分布式静态资源；

&nbsp;&nbsp;&nbsp;&nbsp;3）分布式数据和存储；

&nbsp;&nbsp;&nbsp;&nbsp;4）分布式计算。

- 4 集群

- 5 缓存

&nbsp;&nbsp;&nbsp;&nbsp;1）CDN；

&nbsp;&nbsp;&nbsp;&nbsp;2）反向代理缓存；

&nbsp;&nbsp;&nbsp;&nbsp;3）本地缓存；

&nbsp;&nbsp;&nbsp;&nbsp;4）分布式缓存。

- 6 异步

&nbsp;&nbsp;&nbsp;&nbsp;异步架构是典型的生产者消费者模式：1）提高系统可用性；2）加快网站响应速度；3）消除并发访问高峰。

- 7 冗余

&nbsp;&nbsp;&nbsp;&nbsp;1）集群；2）数据库定期备份存档（冷备）、读写分离主从备份（热备）、灾备中心搭建。

- 8 自动化

&nbsp;&nbsp;&nbsp;&nbsp;1）发布过程自动化；

&nbsp;&nbsp;&nbsp;&nbsp;2）自动化代码管理；

&nbsp;&nbsp;&nbsp;&nbsp;3）自动化测试；

&nbsp;&nbsp;&nbsp;&nbsp;4）自动化安全检测；

&nbsp;&nbsp;&nbsp;&nbsp;5）自动化部署；

&nbsp;&nbsp;&nbsp;&nbsp;6）自动化监控；

&nbsp;&nbsp;&nbsp;&nbsp;7）自动化报警；

&nbsp;&nbsp;&nbsp;&nbsp;8）自动化失效转移、自动化失效恢复；

&nbsp;&nbsp;&nbsp;&nbsp;9）自动化降级；

&nbsp;&nbsp;&nbsp;&nbsp;10）自动化分配资源。

- 9 安全

# 3. 网站核心架构要素

- 1 性能

- 2 可用性

- 3 伸缩性

- 4 可扩展性

- 5 安全性

# 4. 网站的高性能架构

## 4.1 网站性能测试

&nbsp;&nbsp;&nbsp;&nbsp;视角：1）用户视角的网站性能；（体验）2）开发人员视角的网站性能；（应用程序本身及相关系统的性能，包括响应延迟、系统吞吐量、并发处理能力、系统稳定性等）3）运维人员视角的网站性能。（资源利用率）

&nbsp;&nbsp;&nbsp;&nbsp;指标：1）响应事件；2）并发数；（同时处理请求的数量，反应系统负载情况）3）吞吐量；（单位事件处理请求数量，体现整体处理能力，TPS、HPS、QPS）4）性能计算器。（Load、CPU、线程数、磁盘、网络等）

&nbsp;&nbsp;&nbsp;&nbsp;性能测试分类：1）性能测试；（业务预期目标内，对系统不断施压，验证系统在资源可接受范围内，是否达到性能预期）2）负载测试；（超过预期目标，不断施压，直到系统饱和）3）压力测试；（超过系统饱和，不断施压，直到系统宕机或者不能再处理任何请求）4）稳定性测试。（特定资源情况下，给系统加载一定的业务量，使系统运行较长一段时间，检测系统是否稳定）

## 4.2 前端性能优化

- 1 浏览器访问优化

&nbsp;&nbsp;&nbsp;&nbsp;1）减少HTTP请求；（合并CSS、合并JS、合并图片）2）使用浏览器缓存；3）启用压缩；4）CSS放在页面前面，JS放置再页面后面；5）减少COOKIE传输。

- 2 CDN加速

&nbsp;&nbsp;&nbsp;&nbsp;缓存静态资源，如图片、文件、CSS、JS脚本、静态网页等，将其设置再网站访问第一跳，离用户最近的地方。

- 3 反向代理

&nbsp;&nbsp;&nbsp;&nbsp;1）保护网站安全作用，建立一个安全屏障；2）缓存静态资源；3）缓存动态内容（业务允许不需要实时的动态内容，通过通知机制/定时刷新机制使反向代理缓存失效或更新）。

## 4.3 应用服务器性能优化

- 1 分布式缓存

&nbsp;&nbsp;&nbsp;&nbsp;28原则。

&nbsp;&nbsp;&nbsp;&nbsp;网站性能优化第一定律：优先考虑使用缓存优化功能。

&nbsp;&nbsp;&nbsp;&nbsp;不合理使用缓存：1）频繁修改的数据；2）没有热点的访问数据；3）数据需要强一致的场景；4）缓存丢失会导致业务问题或性能问题的场景。

&nbsp;&nbsp;&nbsp;&nbsp;缓存预热：缓存系统启动时就把热点数据加载号，缓存预加载手段叫做预热。

&nbsp;&nbsp;&nbsp;&nbsp;缓存穿透：不恰当的业务、或者恶意攻击导致持续性高并发地请求某个不存在的缓存数据，缓存数据本身又不存在，所有请求都会落到数据库，导致数据库压力很大甚至崩溃，这样的问题叫做缓存穿透，解决的方式是缓存空对象。

&nbsp;&nbsp;&nbsp;&nbsp;分布式缓存架构：1）需要更新同步的分布式缓存；（所有缓存服务器保存相同副本，更新或者失效缓存代价巨大）2）不互相通讯的分布式缓存。（将缓存离散到不通缓存服务器上面，一致性HASH路由算法，缓存服务器间不通讯，方便扩展，具有良好的伸缩性）

- 2 消息异步化

&nbsp;&nbsp;&nbsp;&nbsp;数据写入消息后立即返回给用户，数据再后续的业务校验、写数据库等操作可能失败，因此使用消息异步化时候，需要适当修改业务流程进行配合，以免产生纠纷。

&nbsp;&nbsp;&nbsp;&nbsp;网站优化原则：任何可以晚点做的事情都应该晚点再做。

- 3 使用集群

&nbsp;&nbsp;&nbsp;&nbsp;使用负载均衡技术为一个应用构建一个由堕胎服务器组成的服务集群，将并发请求分发到堕胎服务器上面操作，避免单机负载压力过大导致响应缓慢。

- 4 代码优化

&nbsp;&nbsp;&nbsp;&nbsp;1）多线程，原因是IO阻塞与多CPU，需要解决线程安全相关的问题；2）资源复用，池化技术；（数据库连接池、通讯长连接、线程池、复杂对象池）3）合理数据结构；4）垃圾回收。

- 5 存储性能优化

&nbsp;&nbsp;&nbsp;&nbsp;1）机械磁盘与固态硬盘；2）B+树（针对磁盘存储而优化的N叉排序树）与LSM树（N阶合并树）；3）RAID与HDFS（分布式文件系统）。